/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var roi = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[110.40784521277556, -7.3167508403317845],
          [110.46243353064665, -7.3167508403317845],
          [110.46243353064665, -7.261411753752696],
          [110.40784521277556, -7.261411753752696],
          [110.40784521277556, -7.3167508403317845]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// Fungsi untuk ekstraksi tanggal dari sistem:index
function extractDateFromIndex(image) {
  var index = ee.String(image.get('system:index'));
  var dateStr = index.split('_').get(0); // Ambil bagian tanggal
  var date = ee.Date.parse('yyyyMMdd\'T\'HHmmss', dateStr); // Konversi ke objek tanggal
  return image.set('image_date', date); // Simpan properti baru
}

// Fungsi untuk mendapatkan citra Sentinel-2 dengan tanggal paling dekat
function getClosestS2Image(collection, targetDate) {
  return collection.map(function(image) {
    // Ambil tanggal dari system:index untuk Sentinel-2
    var index = ee.String(image.get('system:index'));
    var dateStr = index.split('_').get(0); // Ambil bagian tanggal (yyyyMMdd'T'HHmmss)
    
    // Konversi ke objek tanggal menggunakan format yang benar (yyyyMMdd'T'HHmmss)
    var imageDate = ee.Date.parse('yyyyMMdd\'T\'HHmmss', dateStr); // Format lengkap untuk tanggal dan waktu

    // Hitung selisih hari antara citra dan targetDate
    var diff = ee.Number(imageDate.difference(targetDate, 'day')).abs();
    return image.set('date_diff', diff);
  }).sort('date_diff').first(); // Cari citra dengan selisih paling dekat
}


// Fungsi untuk mendapatkan citra Sentinel-1 dengan tanggal paling dekat
function getClosestS1Image(collection, targetDate) {
  return collection.map(function(image) {
    // Ambil tanggal dari system:time_start untuk Sentinel-1 (Unix timestamp)
    var imageDate = ee.Date(image.get('system:time_start')); // Sudah dalam format Unix timestamp

    // Hitung selisih hari antara citra dan targetDate
    var diff = ee.Number(imageDate.difference(targetDate, 'day')).abs();
    return image.set('date_diff', diff);
  }).sort('date_diff').first(); // Cari citra dengan selisih paling dekat
}

// Fungsi untuk masking cloud Sentinel-2
function maskS2clouds(image) {
  var qa = image.select("QA60");

  var cloudBitMask = 1 << 10;
  var cirrusBitMask = 1 << 11;

  var mask = qa
    .bitwiseAnd(cloudBitMask)
    .eq(0)
    .and(qa.bitwiseAnd(cirrusBitMask).eq(0));

  return image.updateMask(mask).divide(10000);
}

// ROI dan waktu
var startDate = '2024-01-01';
var endDate = '2024-12-31';

// Koleksi Sentinel-2 dengan mask cloud dan tanggal dari sistem:index
var sentinel2 = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
  .filterBounds(roi)
  .filterDate(startDate, endDate)
  .filterMetadata('CLOUD_COVERAGE_ASSESSMENT', 'less_than', 10)
  .map(maskS2clouds)
  .map(extractDateFromIndex) // Tambahkan properti tanggal
  .sort('CLOUD_COVERAGE_ASSESSMENT'); // Urutkan berdasarkan tutupan awan terendah

// Koleksi Sentinel-1 dengan sistem:time_start untuk tanggal
var sentinel1 = ee.ImageCollection('COPERNICUS/S1_GRD')
  .filterBounds(roi)
  .filterDate(startDate, endDate);

// Ambil citra Sentinel-2 pertama (dengan tutupan awan terendah) sebagai referensi tanggal
var targetImageS2 = sentinel2.first();
var targetDate = ee.Date(targetImageS2.get('image_date'));
print("Target date =", targetDate)

// Ambil citra Sentinel-1 dan Sentinel-2 pada tanggal yang paling dekat
var closestS2 = getClosestS2Image(sentinel2, targetDate);
var closestS1 = getClosestS1Image(sentinel1, targetDate);

// Tampilkan hasil
Map.addLayer(closestS2.clip(roi), {bands: ['B4', 'B3', 'B2'], min: 0, max: 0.3}, 'Closest Sentinel-2');
Map.addLayer(closestS1.clip(roi), {bands: ['VV'], min: -30, max: 5}, 'Closest Sentinel-1');
